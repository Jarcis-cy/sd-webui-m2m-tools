# sd-webui-m2m-tools

### 横屏转竖屏视频

主要是为了解决使用pr的自动重构序列后的竖屏视频没办法再回到原版的长视频的问题

1. 为什么需要横屏转竖屏？
   - 横屏的视频中的人物占比较低，可能会导致AI生成的时候，出现低质量的脸部的问题，以及表情不可控
2. 为什么又要把竖屏转会横屏？
   - 改成竖屏后，缺少了很多的原本场景中的环境内容和镜头与音乐配合的部分，少了点味道
3. 自动重构序列为什么转不回横屏？
   - 没有位置记录的信息，重构序列一般是选择追踪主体人物，所以镜头会变，不是固定的，所以在没有位置信息的前提下，确实拼不回去

所以该插件主要就是为了解决这个问题，一共分为五个步骤（该插件默认你会使用ebs插件，所以生成的项目文件夹中的文件名称和文件夹名称都按照ebs的格式来，便于操作）

#### stage 1
输入原视频地址以及项目文件夹地址，可以选择是否按照原视频帧率拆帧，如果不自定义拆帧帧率，则按照原视频帧率拆帧。
会创建frame文件夹并把每帧都放入frame文件夹中。

#### stage 2
如果使用segment anything做批量抠图的话，可以使用这一步。

1. 开启GroundingDINO，源目录填写 项目地址/frame 目标目录填写 项目地址/Out 
2. 单独输出每张图像一般选择3，这样可以选择更合适的抠图效果
3. 选择保存蒙版后图像和保存蒙版
4. 开始批量处理

处理完成后，可以前往 项目地址/Out 中选择合适的抠图效果，0、1、2中的一个，然后在插件中选择一个，点击生成，插件会自动将对应编号的蒙版后图像保存到Human文件夹
将蒙版图像保存到Mask文件夹，并重命名为跟原图名称一致。

#### stage 3
点击运行，会创建好video_frame、video_mask文件夹，然后执行重构序列的操作，并将过程中记录的位置信息保存到crop_info.json这个文件中，
将重构好的frame保存到video_frame文件夹中，重构好的mask保存到video_mask文件夹中。

#### stage 4
重新合并帧序列，将重构好的帧重新生成一个新的视频，便于ebs处理

直接点击运行，即可参考原视频的帧率进行合成视频，生成一个tmp.mp4（可修改）保存到项目文件夹中

也可以在文本框中输入一个帧序列地址，然后指定帧率进行合成，不指定则参考原视频的帧率

#### stage 5
前往ebs的流程操作，进行生成key帧->图生图->图片放大还原->生成ebs文件->风格迁移->生成新视频（也就是ebs插件执行完stage 7）

执行完成后，应该会有一个文件夹crossfade_tmp，这个文件夹中存放着所有的风格迁移好的文件，此时点击运行，插件会先创建refactor_frame文件夹，然后会读取crossfade_tmp中的所有png文件，
然后根据crop_info.json的内容，将这个文件夹中的同名文件叠加到frame文件夹的同名文件上，并保存到refactor_frame中，这个文件夹中的内容即是变回横板后的图片。

此时可以回到stage 4，生成视频。

### 用来批量处理tag的脚本

主要是在做AI动画的时候，需要对批量生成的tag做一些处理：
- 批量替换一些tag,如果没有填写要替换的内容，则会为所有文件添加填写的新词
- 批量删除一些tag
- 对tag根据词频进行统计，查看是否存在意料之外的词
- 搜索相关tag
- 可以根据预设筛选词汇